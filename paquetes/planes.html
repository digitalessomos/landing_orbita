<!DOCTYPE html>
<html lang="es" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planes - RutaTotal 360 | Control Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        :root {
            --brand-emerald: #10b981;
            --brand-slate: #020617;
            --card-bg: rgba(30, 41, 59, 0.5);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--brand-slate);
            color: #f8fafc;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-8px);
            border-color: var(--brand-emerald);
            box-shadow: 0 20px 40px -20px rgba(16, 185, 129, 0.3);
        }

        .btn-emerald {
            background: var(--brand-emerald);
            color: #020617;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-emerald:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            filter: brightness(1.1);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(16px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .form-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--brand-emerald);
            background: rgba(16, 185, 129, 0.05);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        /* ValidaciÃ³n visual */
        .form-input:not(:placeholder-shown):valid {
            border-color: var(--brand-emerald);
        }

        /* Video Modal Styles */
        #video-modal {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(20px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #video-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .video-container {
            width: 90%;
            max-width: 1000px;
            aspect-ratio: 16 / 9;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #video-modal.active .video-container {
            transform: scale(1);
        }

        .close-video {
            position: absolute;
            top: -50px;
            right: 0;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .close-video:hover {
            transform: rotate(90deg) scale(1.1);
            color: var(--brand-emerald);
        }
    </style>
</head>

<body class="antialiased selection:bg-emerald-500/30">

    <section class="py-24 px-6 relative overflow-hidden">
        <!-- DecoraciÃ³n de fondo -->
        <div class="absolute top-0 -left-20 w-80 h-80 bg-emerald-500/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-0 -right-20 w-80 h-80 bg-emerald-500/10 rounded-full blur-[120px]"></div>

        <div class="max-w-7xl mx-auto text-center relative z-10">
            <span class="text-emerald-500 font-bold tracking-[0.3em] uppercase text-xs mb-4 block">Torre de
                Control</span>
            <h2 class="text-4xl md:text-6xl font-black text-white mb-6 italic tracking-tighter">SOLUCIONES A TU MEDIDA
            </h2>
            <p class="text-xl text-slate-400 mb-16 max-w-2xl mx-auto">
                No vendemos software, entregamos <span class="text-white font-bold italic">liderazgo y control</span>
                para desactivar el caos en tu cocina.
            </p>

            <!-- Contenedor DinÃ¡mico de Planes -->
            <div id="pricing-container" class="flex justify-center mb-20">
                <!-- El plan se inyecta aquÃ­ -->
            </div>

            <!-- BotÃ³n de Contacto General -->
            <div class="glass-card p-10 rounded-3xl border-emerald-500/20 inline-block max-w-2xl">
                <h3 class="text-2xl font-black mb-4 text-white uppercase italic tracking-tight">Â¿OperaciÃ³n a Gran
                    Escala?</h3>
                <p class="text-slate-400 mb-8 leading-relaxed">Si gestiones mÃ¡s de 20 repartidores o mÃºltiples
                    sucursales, diseÃ±amos una infraestructura dedicada para tu marca.</p>
                <button onclick="openLeadModal('Plan Customizado')"
                    class="btn-emerald px-10 py-5 rounded-2xl font-black text-lg uppercase tracking-tighter flex items-center gap-3 mx-auto">
                    <i class="fas fa-headset"></i> Hablar con un Experto
                </button>
            </div>
        </div>
    </section>

    <!-- Modal de Captura de Leads (Firebase Ready) -->
    <div id="lead-modal" class="modal-overlay">
        <div class="max-w-md w-full glass-card p-8 rounded-[2.5rem] border-emerald-500/30 shadow-2xl m-4">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <span class="text-emerald-500 text-[10px] font-black uppercase tracking-widest block mb-1">Paso
                        Final</span>
                    <h3 class="text-2xl font-black text-white italic tracking-tight uppercase" id="modal-plan-title">
                        Configurar Acceso</h3>
                </div>
                <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="lead-form" class="space-y-5" onsubmit="handleLeadSubmit(event)">
                <div>
                    <label
                        class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-2 block">Comandante
                        / Encargado</label>
                    <input type="text" id="lead-name" required placeholder="Ej: Juan PÃ©rez"
                        class="w-full form-input px-5 py-4 rounded-xl font-medium">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-2 block">Base
                        de Operaciones (Local)</label>
                    <input type="text" id="lead-local" required placeholder="Ej: Pizza House Ramos"
                        class="w-full form-input px-5 py-4 rounded-xl font-medium">
                </div>
                <div>
                    <label
                        class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-2 block">Cantidad
                        de Repartidores</label>
                    <select id="lead-fleet" required
                        class="w-full form-input px-5 py-4 rounded-xl font-medium appearance-none">
                        <option value="" disabled selected>Selecciona una escala</option>
                        <option value="1-5">1 a 5 (GestiÃ³n BÃ¡sica)</option>
                        <option value="5-15">5 a 15 (LogÃ­stica Activa)</option>
                        <option value="15+">MÃ¡s de 15 (Torre de Control)</option>
                    </select>
                </div>

                <button type="submit"
                    class="w-full btn-emerald py-5 rounded-2xl font-black uppercase tracking-tighter shadow-lg shadow-emerald-500/20 mt-4">
                    Comenzar TransformaciÃ³n
                </button>
                <p class="text-[9px] text-center text-slate-500 font-bold uppercase tracking-widest mt-6">
                    <i class="fas fa-shield-alt mr-1"></i> Datos protegidos con cifrado militar
                </p>
            </form>
        </div>
    </div>

    <!-- BotÃ³n Flotante para el Asistente -->
    <button onclick="toggleChat()" id="chat-trigger"
        class="fixed bottom-6 right-6 z-[60] w-14 h-14 bg-emerald-500 text-slate-950 rounded-full shadow-2xl shadow-emerald-500/40 flex items-center justify-center hover:scale-110 active:scale-95 transition-all group overflow-hidden">
        <i class="fas fa-robot text-2xl group-hover:rotate-12 transition-transform"></i>
        <!-- Ping de notificaciÃ³n -->
        <span
            class="absolute top-0 right-0 w-3 h-3 bg-red-500 border-2 border-slate-950 rounded-full animate-ping"></span>
    </button>

    <!-- Video Modal -->
    <div id="video-modal" onclick="if(event.target === this) closeVideoModal()">
        <div class="video-container">
            <button onclick="closeVideoModal()" class="close-video">
                <i class="fas fa-times"></i>
            </button>
            <video id="pills-video" class="w-full h-full rounded-2xl shadow-2xl border border-white/10" playsinline
                muted loop preload="auto" controls>
                <source src="../videos/video_chatbot.mov" type="video/mp4">
                <source src="../videos/video_chatbot.mov">
                Tu navegador no soporta el tag de video.
            </video>
        </div>
    </div>

    <div id="chatbot-container" class="hidden fixed bottom-5 right-5 z-50 w-80 sm:w-96">
        <div class="glass-card p-4 shadow-2xl border border-emerald-500/30 flex flex-col h-[450px]">
            <div class="flex justify-between items-center border-b border-white/10 pb-2 mb-2">
                <h3 class="text-emerald-400 font-bold flex items-center gap-2">
                    <i class="fas fa-robot"></i> Asistente RutaTotal
                </h3>
                <button onclick="toggleChat()" class="text-white/50 hover:text-white transition-colors">&times;</button>
            </div>

            <div id="chat-messages" class="flex-grow overflow-y-auto space-y-3 mb-4 text-sm scroll-smooth">
                <div class="bg-white/10 p-3 rounded-lg rounded-tl-none">
                    Â¡Hola! ðŸ‘‹ Soy tu asistente de RutaTotal. Â¿Con quiÃ©n tengo el gusto de hablar?
                </div>
            </div>

            <div id="chat-input-area" class="mt-auto">
                <input type="text" id="bot-input"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-2 text-white focus:outline-none focus:border-emerald-500"
                    placeholder="Escribe tu nombre...">
                <button id="bot-send-btn"
                    class="w-full mt-2 bg-emerald-600 hover:bg-emerald-500 p-2 rounded-lg font-bold transition-all">Siguiente</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { PLANES_CONFIG as planes } from '../src/config/plans.js';

        // --- FIREBASE CONFIG & ROUTER ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZB3RtpYVjrCQzPzRD4JgCBnSuJ7UqOjM",
            authDomain: "orbita-fase3.firebaseapp.com",
            projectId: "orbita-fase3",
            storageBucket: "orbita-fase3.firebasestorage.app",
            messagingSenderId: "986330027557",
            appId: "1:986330027557:web:5f3e215efc3d27371b11cc",
            measurementId: "G-F2TTR09P4L"
        };

        class FireRouter {
            constructor() {
                try {
                    this.app = initializeApp(firebaseConfig);
                    this.db = getFirestore(this.app);
                    this.initialized = true;
                    console.log("ðŸ”¥ [Torre de Control] Firebase Conectado");
                } catch (e) {
                    console.error("Error connecting to Control Tower:", e);
                    this.initialized = false;
                }
            }

            async saveLead(data) {
                if (!this.initialized) return { error: "Offline Mode" };
                try {
                    const docRef = await addDoc(collection(this.db, "leads_inbox"), {
                        ...data,
                        timestamp: serverTimestamp(),
                        source: 'landing_planes',
                        status: 'new'
                    });
                    console.log("Packet sent with ID: ", docRef.id);
                    return { success: true, id: docRef.id };
                } catch (e) {
                    console.error("Error sending packet:", e);
                    return { error: e.message };
                }
            }

            async saveChatSession(sessionData) {
                if (!this.initialized) return;
                try {
                    await addDoc(collection(this.db, "chat_sessions"), {
                        ...sessionData,
                        savedAt: serverTimestamp()
                    });
                } catch (e) { console.error("Chat log error:", e); }
            }
        }

        const fireRouter = new FireRouter();

        // --- CHATBOT CORE (ES6 Class) ---
        class ChatbotCore {
            constructor() {
                this.step = 'HOOK';
                this.data = { context: '', volume: '', specialty: '', nombre: '', local: '', plan: '' };
                this.isOpen = false;
                this.history = [];

                this.container = document.getElementById('chatbot-container');
                this.messagesArea = document.getElementById('chat-messages');
                this.inputArea = document.getElementById('chat-input-area');
                this.triggerBtn = document.getElementById('chat-trigger');

                this.bindEvents();
                this.initFlow();
            }

            startPlanFlow(planName) {
                this.data.plan = planName;
                this.toggle('open');
                this.messagesArea.innerHTML = '';
                this.botSay(`Â¡Excelente elecciÃ³n! El <span class='text-emerald-400 font-black'>${planName}</span> es un gran paso hacia el control total.`);
                setTimeout(() => {
                    this.botSay("Para darte el diagnÃ³stico correcto y avanzar con este plan, Â¿cuÃ¡ntos repartidores manejas actualmente?");
                    this.step = 'VOLUME';
                    this.renderOptions([
                        { text: "1 a 5 Repartidores", value: "1-5" },
                        { text: "5 a 10 Repartidores", value: "5-10" },
                        { text: "+10 Repartidores", value: "+10" }
                    ]);
                }, 800);
            }

            bindEvents() {
                this.triggerBtn.onclick = () => this.toggle();
                this.container.querySelector('button.text-white\\/50').onclick = () => this.toggle();
            }

            toggle(state) {
                this.isOpen = (state === 'open') ? true : (state === 'close') ? false : !this.isOpen;
                this.container.classList.toggle('hidden', !this.isOpen);
                if (this.isOpen) setTimeout(() => this.scrollToBottom(), 100);
            }

            scrollToBottom() {
                this.messagesArea.scrollTop = this.messagesArea.scrollHeight;
            }

            initFlow() {
                this.messagesArea.innerHTML = '';
                this.botSay("Â¡Hola! ðŸ‘‹ Soy el estratega virtual de <span class='text-emerald-400 font-black'>RutaTotal 360</span>.");
                setTimeout(() => {
                    this.botSay("Antes de hablar de software, cuÃ©ntame: Â¿Sientes que tu logÃ­stica es un caos o solo quieres escalar lo que ya funciona?");
                    this.renderOptions([
                        { text: "Â¡Es un caos total!", value: "caos" },
                        { text: "Quiero escalar mis ventas.", value: "escalar" },
                        { text: "Solo estoy curioseando.", value: "curioso" }
                    ]);
                }, 800);
            }

            botSay(html) {
                this.addMessage(html, 'bot');
                this.history.push({ sender: 'bot', content: html, time: new Date().toISOString() });
            }

            userSay(text) {
                this.addMessage(text, 'user');
                this.history.push({ sender: 'user', content: text, time: new Date().toISOString() });
            }

            addMessage(content, sender) {
                const div = document.createElement('div');
                div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4 animate-fade-in`;
                const bubble = document.createElement('div');
                bubble.className = sender === 'user'
                    ? "bg-emerald-600/20 text-emerald-100 p-3 rounded-2xl rounded-tr-none max-w-[85%] border border-emerald-500/20"
                    : "bg-white/5 text-slate-300 p-3 rounded-2xl rounded-tl-none max-w-[85%] border border-white/10";
                bubble.innerHTML = content;
                div.appendChild(bubble);
                this.messagesArea.appendChild(div);
                this.scrollToBottom();
            }

            renderOptions(options) {
                this.inputArea.innerHTML = '';
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 gap-2 w-full";

                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left bg-white/5 hover:bg-emerald-600/20 border border-white/10 hover:border-emerald-500/50 p-3 rounded-xl text-xs font-bold text-slate-300 transition-all transform hover:scale-[1.02] active:scale-95";
                    btn.innerHTML = opt.text;
                    btn.onclick = () => this.handleSelection(opt);
                    grid.appendChild(btn);
                });
                this.inputArea.appendChild(grid);
            }

            handleSelection(opt) {
                this.userSay(opt.text);

                if (this.step === 'HOOK') {
                    if (opt.value === 'curioso') {
                        this.botSay("Â¡Genial! El que curiosea es porque sabe que siempre hay algo que mejorar. ðŸ’¡");
                        setTimeout(() => {
                            this.botSay("Mira este dato: Los negocios que automatizan su logÃ­stica antes de que sea un caos, escalan un <b>40% mÃ¡s rÃ¡pido</b>. ï¿½ Â¿Te gustarÃ­a ver un ejemplo real de Ã©xito?");
                            this.renderOptions([
                                { text: "SÃ­, muÃ©strame cÃ³mo.", value: "si_escalar" },
                                { text: "Solo quiero ver precios.", value: "escalar" }
                            ]);
                        }, 800);
                    } else {
                        this.data.context = opt.value;
                        this.step = 'VOLUME';
                        this.nextStep();
                    }
                } else if (this.step === 'VOLUME' || opt.value === 'si_escalar') {
                    this.data.volume = opt.value === 'si_escalar' ? '5-10' : opt.value; // Default to medium if re-engaging
                    this.step = 'SPECIALTY';
                    this.nextStep();
                } else if (this.step === 'SPECIALTY') {
                    this.data.specialty = opt.value;
                    this.step = 'AHA';
                    this.nextStep();
                }
            }

            nextStep() {
                this.inputArea.innerHTML = '<div class="flex justify-center p-2"><i class="fas fa-circle-notch animate-spin text-emerald-500"></i></div>';

                setTimeout(() => {
                    if (this.step === 'VOLUME') {
                        this.botSay("Entendido. Para darte el diagnÃ³stico correcto, Â¿cuÃ¡ntos repartidores manejas actualmente?");
                        this.renderOptions([
                            { text: "1 a 5 Repartidores", value: "1-5" },
                            { text: "5 a 10 Repartidores", value: "5-10" },
                            { text: "+10 Repartidores", value: "+10" }
                        ]);
                    }
                    else if (this.step === 'SPECIALTY') {
                        this.botSay("Perfecto. Cada cocina es un mundo diferente. Â¿CuÃ¡l es la especialidad de tu local?");
                        this.renderOptions([
                            { text: "<i class='fas fa-pizza-slice mr-2'></i> PizzerÃ­a", value: "pizzeria" },
                            { text: "<i class='fas fa-fish mr-2'></i> Sushi", value: "sushi" },
                            { text: "<i class='fas fa-hamburger mr-2'></i> Hamburguesas", value: "burgers" },
                            { text: "<i class='fas fa-utensils mr-2'></i> Restaurante Tradicional", value: "restaurante" }
                        ]);
                    }
                    else if (this.step === 'AHA') {
                        this.generateAhaMoment();
                    }
                }, 800);
            }

            generateAhaMoment() {
                const { volume, specialty } = this.data;
                let script = "";

                if (specialty === 'pizzeria') {
                    if (volume === '1-5') {
                        script = "Gestionar repartidores en una pizzerÃ­a es una pesadilla de tiempos. Una optimizaciÃ³n del 15% en tus rutas te ahorrarÃ­a combustible y evitarÃ­a que las pizzas lleguen frÃ­as. Â¿Quieres ver cÃ³mo lo automatizamos?";
                    } else {
                        script = "En el negocio de la pizza, el tiempo es calidad. Si tus repartidores se pierden o se amontonan, la masa llega frÃ­a y el cliente no vuelve. Con tantas unidades, necesitas rutas optimizadas. Â¿Listo para que lleguen siempre calientes?";
                    }
                } else if (specialty === 'sushi') {
                    if (volume === '1-5') {
                        script = "En el sushi, 10 minutos de retraso arruinan la experiencia. Con varios repartidores, el dueÃ±o suele perder horas coordinando. Â¿QuÃ© harÃ­as si recuperaras esas horas garantizando frescura?";
                    } else {
                        script = "El sushi es arte y logÃ­stica de precisiÃ³n. Un minuto de mÃ¡s afecta la frescura. Para una operaciÃ³n de muchos repartidores, necesitas trazabilidad total. Evita el 'Â¿donde estÃ¡ mi pedido?'. Â¿Te gustarÃ­a automatizarlo?";
                    }
                } else if (specialty === 'burgers') {
                    if (volume === '1-5') {
                        script = "Tus 'horas pico' son brutales. Cuando caen 20 pedidos en 10 minutos, el caos del mostrador se traslada a la calle. Necesitas un despacho quirÃºrgico. Â¿Quieres ver cÃ³mo despejamos tu mostrador?";
                    } else {
                        script = "<b>Â¡El Fin de las Preguntas al Aire!</b> ðŸ›‘<br><br>Basta de preguntar: <i>Â¿QuiÃ©n se llevÃ³ el pedido 45? Â¿Hace cuÃ¡nto saliÃ³?</i>. Con nuestra interfaz visual, solo miras la pantalla y ves al repartidor y el tiempo exacto. Â¿Listo para la Torre de Control?";
                    }
                } else { // Restaurante
                    if (volume === '1-5') {
                        script = "Gestionar salÃ³n y delivery al mismo tiempo es de malabaristas. Vamos a profesionalizar tu logÃ­stica para que te enfoques en el sabor, no en el mapa. Â¿Te enviamos la propuesta?";
                    } else {
                        script = "<b>Torre de Control Digital</b> ðŸ—¼<br><br>En un restaurante con mucho flujo, no se necesita preguntar. Nuestra trazabilidad 360 por colores te permite saber quiÃ©n tiene cada pedido solo con mirar el monitor. Â¿Te gustarÃ­a implementarlo?";
                    }
                }

                this.botSay(script);

                // FASE 4.5: El Puente de Valor (Micro-DemostraciÃ³n)
                setTimeout(() => {
                    this.botSay("AsÃ­ se ve tu operaciÃ³n bajo control en <span class='text-emerald-400 font-black'>Monitor de Pedidos</span>. Â¿Te lo imaginas en tu local?");
                    this.botSay(`<div class="rounded-xl overflow-hidden border border-emerald-500/30 shadow-2xl mt-2">
                        <video src="../videos/monitor.MOV" autoplay loop muted playsinline class="w-full"></video>
                    </div>`);

                    setTimeout(() => {
                        this.botSay("Para enviarte el anÃ¡lisis de costos y la propuesta personalizada, Â¿con quiÃ©n tengo el gusto de hablar?");
                        this.step = 'LEAD_NAME';
                        this.renderInput("Ingrese su nombre...");
                    }, 4000);
                }, 2000);
            }

            renderInput(placeholder) {
                this.inputArea.innerHTML = `
                    <div class="flex flex-col gap-2 w-full">
                        <input type="text" id="bot-input" 
                            class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white focus:outline-none focus:border-emerald-500 text-sm" 
                            placeholder="${placeholder}">
                        <button id="bot-send-btn" class="bg-emerald-600 hover:bg-emerald-500 p-4 rounded-xl font-black uppercase tracking-tighter transition-all active:scale-95">Continuar</button>
                    </div>
                `;
                const input = document.getElementById('bot-input');
                const btn = document.getElementById('bot-send-btn');

                const submit = () => {
                    const val = input.value.trim();
                    if (val) this.handleTextInput(val);
                };

                btn.onclick = submit;
                input.onkeypress = (e) => { if (e.key === 'Enter') submit(); };
                setTimeout(() => input.focus(), 200);
            }

            handleTextInput(val) {
                if (this.step === 'LEAD_CONTACT') {
                    // ValidaciÃ³n simple de Email o TelÃ©fono (mÃ­nimo 6 dÃ­gitos para tel)
                    const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
                    const isPhone = /^\+?[\d\s-]{6,}$/.test(val);

                    if (!isEmail && !isPhone) {
                        this.botSay("Ups, parece que faltÃ³ un dÃ­gito o el formato es invÃ¡lido. ðŸ˜… Necesito tu contacto para enviarte el diagnÃ³stico personalizado.");
                        return; // Detener flujo hasta que sea vÃ¡lido
                    }
                }

                this.userSay(val);
                if (this.step === 'LEAD_NAME') {
                    this.data.nombre = val;
                    this.botSay(`Excelente Comandante ${val}. Â¿CÃ³mo se llama su Base de Operaciones (Local)?`);
                    this.step = 'LEAD_LOCAL';
                    this.renderInput("Nombre de su local...");
                } else if (this.step === 'LEAD_LOCAL') {
                    this.data.local = val;
                    this.botSay("Â¡Perfecto! Un Ãºltimo detalle: Â¿Email o WhatsApp para enviarte el anÃ¡lisis de costos?");
                    this.step = 'LEAD_CONTACT';
                    this.renderInput("Email o WhatsApp...");
                } else if (this.step === 'LEAD_CONTACT') {
                    this.data.contacto = val;
                    this.finishFlow();
                }
            }

            finishFlow() {
                this.botSay("<b>Â¡AnÃ¡lisis completado!</b> ðŸŽ¯ El sistema estÃ¡ generando tu propuesta estratÃ©gica.");

                // RecomendaciÃ³n de Plan
                const planRecomendado = 'Fase 03: Torre de Control 360';
                this.data.plan = planRecomendado;

                // Mapeo de CTAs personalizados por nicho
                const ctaMap = {
                    pizzeria: "Optimizar mis entregas de Pizza",
                    sushi: "Garantizar frescura en mis envÃ­os",
                    burgers: "Eliminar el caos en mi mostrador",
                    restaurante: "Activar mi Torre de Control"
                };
                const ctaText = ctaMap[this.data.specialty] || "Obtener mi Propuesta Personalizada";

                // Sync with Firebase
                fireRouter.saveChatSession({
                    lead: this.data,
                    history: this.history
                });

                document.getElementById('chat-input-area').innerHTML = `
                    <div class="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-2xl text-center">
                        <p class="text-[10px] font-black uppercase text-emerald-400 mb-2">Plan Sugerido</p>
                        <h4 class="text-white font-black mb-4">${planRecomendado}</h4>
                        <button onclick="window.location.reload()" class="text-[9px] text-slate-500 uppercase font-black hover:text-white transition-colors">Iniciar nuevo diagnÃ³stico</button>
                    </div>
                `;

                setTimeout(() => {
                    const nicho = this.data.specialty === 'pizzeria' ? 'tu PizzerÃ­a' :
                        this.data.specialty === 'sushi' ? 'tu Sushi' :
                            this.data.specialty === 'burgers' ? 'tus Hamburguesas' : 'tu Restaurante';

                    this.botSay(`Mira cÃ³mo transformamos el caos en <span class='text-emerald-400 font-black'>${nicho}</span> en 45 segundos.`);

                    setTimeout(() => {
                        this.botSay(`<button onclick="openVideoModal()" class="w-full bg-white/10 hover:bg-emerald-600/20 border border-emerald-500/30 text-emerald-400 p-3 rounded-xl text-center font-black uppercase tracking-tight text-xs mt-2 flex items-center justify-center gap-2">
                            <i class="fas fa-play-circle"></i> Ver los 3 Mandamientos
                        </button>`);
                    }, 1000);
                }, 1500);


                setTimeout(() => {
                    const msg = `[ALTA PRIORIDAD] Soy ${this.data.nombre} de ${this.data.local} (${this.data.specialty}). Solicito presupuesto para ${this.data.volume} repartidores.`;
                    const encoded = encodeURIComponent(msg);
                    const waLink = `https://wa.me/5491159665917?text=${encoded}`;

                    this.botSay(`<a href="${waLink}" target="_blank" class="block w-full bg-emerald-600 hover:bg-emerald-500 text-white p-3 rounded-xl text-center font-black uppercase tracking-tight text-xs mt-4 animate-bounce">${ctaText}</a>`);
                }, 4000);
            }
        }

        const chatbot = new ChatbotCore();

        // --- LEAD FORM LOGIC ---
        // Expose functions for HTML onclick attributes (bridge between HTML and Modules)
        window.openLeadModal = (planName) => {
            window.selectedPlan = planName;
            document.getElementById('modal-plan-title').innerText = planName;
            document.getElementById('lead-modal').classList.add('active');
        };

        window.closeModal = () => {
            document.getElementById('lead-modal').classList.remove('active');
        };

        window.handleLeadSubmit = async (event) => {
            event.preventDefault();

            const btn = event.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;

            // Visual Feedback: Processing
            btn.innerHTML = '<i class="fas fa-satellite-dish animate-pulse"></i> Sincronizando...';
            btn.disabled = true;

            const leadData = {
                plan: window.selectedPlan,
                nombre: document.getElementById('lead-name').value,
                local: document.getElementById('lead-local').value,
                flota: document.getElementById('lead-fleet').value
            };

            // Send to Firestore
            await fireRouter.saveLead(leadData);

            // Success Animation
            btn.innerHTML = '<i class="fas fa-check"></i> Datos Recibidos';
            btn.classList.replace('btn-emerald', 'bg-emerald-600');


            setTimeout(() => {
                // WhatsApp Messages Logic
                const msgMap = {
                    'Plan Customizado': `Hola, soy ${leadData.nombre} de ${leadData.local}. Necesito asesoramiento experto para una operaciÃ³n de ${leadData.flota} repartidores.`,
                    'default': `[WEB FORM] Hola, soy ${leadData.nombre} de ${leadData.local}. Solicito activaciÃ³n del plan ${leadData.plan} para ${leadData.flota} repartidores.`
                };
                const msg = msgMap[leadData.plan] || msgMap['default'];
                const encoded = encodeURIComponent(msg);

                // Device Detection & Fallback Logic
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                if (isMobile) {
                    window.open(`https://wa.me/5491159665917?text=${encoded}`, '_blank');
                } else {
                    // Desktop Strategy: Open WhatsApp Web AND Show Fallback
                    const waWindow = window.open(`https://web.whatsapp.com/send?phone=5491159665917&text=${encoded}`, '_blank');

                    // If blocked or closed, we already have the lead in Firestore.
                    // We show a 'Check' modal to confirm next steps
                    alert("Â¡Gracias! Se intentÃ³ abrir WhatsApp Web. Si no se abriÃ³, no te preocupes, ya recibimos tus datos y te contactaremos a la brevedad.");
                }

                window.closeModal();
                event.target.reset();

                // Restore Button
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                    btn.classList.add('btn-emerald');
                }, 500);
            }, 1000);
        };

        // Bridge for Plan Cards
        window.startPlanChat = (planName) => chatbot.startPlanFlow(planName);
        window.toggleChat = () => chatbot.toggle();

        // --- VIDEO MODAL LOGIC ---
        window.openVideoModal = () => {
            const modal = document.getElementById('video-modal');
            const video = document.getElementById('pills-video');
            modal.classList.add('active');

            // Forzar carga y reproducciÃ³n
            video.currentTime = 0;
            video.load();
            const playPromise = video.play();

            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Autoplay prevented, showing controls:", error);
                    video.muted = true;
                    video.play();
                });
            }
            document.body.style.overflow = 'hidden';
        };

        window.closeVideoModal = () => {
            const modal = document.getElementById('video-modal');
            const video = document.getElementById('pills-video');
            modal.classList.remove('active');
            video.pause();
            document.body.style.overflow = ''; // Restore scroll
        };

        // --- RENDER PLANES ---
        function renderPlanes() {
            const container = document.getElementById('pricing-container');
            container.innerHTML = planes.map(plan => `
                <div class="glass-card rounded-[2.5rem] p-10 flex flex-col relative max-w-lg ${plan.popular ? 'border-emerald-500/50 ring-1 ring-emerald-500/20 shadow-2xl shadow-emerald-500/10' : ''}">
                    ${plan.popular ? '<span class="absolute -top-4 left-1/2 -translate-x-1/2 bg-emerald-500 text-slate-950 px-5 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest shadow-lg shadow-emerald-500/30">Plan 360 Ã“rbita</span>' : ''}
                    
                    <div class="text-emerald-500 font-black text-[10px] uppercase tracking-[0.3em] mb-4">${plan.fase}</div>
                    <h3 class="text-3xl font-black text-white mb-2 italic tracking-tighter uppercase">${plan.titulo}</h3>
                    <p class="text-emerald-400/80 font-bold text-xs uppercase tracking-widest mb-4">${plan.subtitulo}</p>
                    <p class="text-slate-400 mb-8 text-sm leading-relaxed">${plan.descripcion}</p>
                    
                    <div class="mb-10 p-6 rounded-2xl bg-white/5 border border-white/5">
                        <div class="flex items-baseline gap-1 justify-start">
                            <span class="text-5xl font-black text-white tracking-tighter">${typeof plan.precioMensual === 'number' ? '$' + plan.precioMensual : plan.precioMensual}</span>
                            ${typeof plan.precioMensual === 'number' ? '<span class="text-slate-500 font-bold text-sm uppercase">/ mes</span>' : ''}
                        </div>
                        <p class="text-slate-500 text-[10px] font-bold mt-2 uppercase tracking-widest">
                            InstalaciÃ³n: <span class="text-emerald-500">${typeof plan.precioInstalacion === 'number' ? '$' + plan.precioInstalacion : plan.precioInstalacion}</span>
                        </p>
                    </div>

                    <ul class="text-left space-y-4 mb-10 flex-1">
                        ${plan.caracteristicas.map(feat => `
                            <li class="flex items-start gap-3 text-slate-400 text-[13px] leading-tight">
                                <i class="fas fa-check-double text-emerald-500 text-[10px] mt-1"></i>
                                <span class="font-medium">${feat}</span>
                            </li>
                        `).join('')}
                    </ul>

                    <button onclick="startPlanChat('${plan.titulo}')" 
                            class="w-full py-5 rounded-2xl font-black uppercase tracking-tighter transition-all ${plan.popular ? 'btn-emerald' : 'bg-white/5 text-white border border-white/10 hover:bg-white/10'}">
                        ${plan.cta}
                    </button>
                </div>
            `).join('');
        }

        window.addEventListener('load', renderPlanes);
    </script>
</body>

</html>